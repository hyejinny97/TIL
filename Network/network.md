# ✔ 네트워크 계층

## 1️⃣ LAN을 넘어서는 네트워크 계층

- LAN을 넘어서 다른 네트워크와 통신하기 위해선 네트워크 계층의 역할이 필수

### 데이터 링크 계층의 한계

#### 1. 물리 계층과 데이터 링트 계층만으로는 다른 네트워크까지의 도달 경로를 파악하기 어려움

- 물리 계층과 데이터 링크 계층은 기본적으로 LAN을 다루는 계층
- 라우팅: 패킷이 이동할 최적의 경로를 결정하는 것
- 라우터: 라우팅을 수행하는 대표적인 네트워크 장비

#### 2. MAC 주소만으로는 모든 네트워크에 속한 호스트의 위치를 특정하기 어려움

- MAC 주소: 일반적으로 NIC마다 할당되는 고정된 주소(물리 주소)
- IP 주소: 호스트에 직접 할당 가능한 주소(논리 주소)
- MAC 주소가 택배의 수신인 역할이라면, IP 주소는 수신지 역할
- 네트워크에서 MAC 주소와 IP 주소를 함께 사용하고, 기본적으로 IP 주소를 우선으로 활용함

### 인터넷 프로토콜

- 네트워크 계층의 가장 핵심적인 프로토콜
- IP에는 두가지 버전이 있음 (IPv4, IPv6)

#### IP 주소 형태

##### IPv4 주소

```
192.168.1.1
```

- 4바이트로 주소를 표헌함
- 점으로 구분된 4개의 10진수로 표기됨
  - 옥텟(octet): 점으로 구분된 1바이트
- 이론적으로 할당 가능한 IPv4 주소는 총 2^32 개 (약 43억 개)

##### IPv6 주소

```
2001:0230:abcd:ffff:0000:0000:ffff:1111
```

- 16바이트로 주소를 표현함
- 콜론으로 구분된 8개 그룹의 16진수로 표기됨
- 이론적으로 할당 가능한 IPv6 주소는 총 2^128 개

#### IP의 기능

##### 1. IP 주소 지정

- IP 주소를 바탕으로 송수신 대상을 지정하는 것

##### 2. IP 단편화

- 전송하고자 하는 패킷의 크기가 MTU라는 최대 전송 단위보다 클 경우, 이를 MTU 크기 이하의 복수의 패킷으로 나누는 것
  - MTU(Maximum Transmission Unit): 한 번에 전송 가능한 IP 패킥의 최대 크기
- IP 패킷의 헤더도 MTU 크기에 포함됨
- 일반적인 MTU 크기는 1500 바이트
- MTU 크기 이하로 나누어진 패킷은 수신지에 도착하면 다시 재조립됨

#### IPv4

- IPv4 패킷 헤더 내 주요 필드
  - 식별자
  - 플래그
  - 단편화 오프셋
  - TTL
  - 프로토콜
  - 송신지 IP 주소
  - 수신지 IP 주소
- IP 단편화에 관여하는 필드: 식별자, 플래그, 단편화 오프셋
- IP 주소 지정에 관여하는 필드: 송신지 IP 주소, 수신지 IP 주소
- IPv4 헤더 길이는 가변적임

##### 1. 식별자

- 패킷에 할당된 번호
- 잘게 쪼개져서 수신지에 도착한 IPv4 패킷들이 어떤 메시지에서부터 쪼개졌는지 인식하기 위해서 사용

##### 2. 플래그

- 3개의 비트로 구성
- 첫 번째 비트: 항상 0으로 예약된 비트
- 두 번쨰 비트: DF(Don't Fragment)로, 1이면 IP 단편화를 수행하지 말라는 의미
- 세 번째 비트: MF(More Fragment)로, 1이면 단편화된 패킷이 더 있다는 의미

##### 3. 단편화 오프셋

- 패킷이 단편화되기 전에 패킷의 초기 데이터에서 몇 번째로 떨어진 패킷인지를 나타냄
- 수신지가 패킷들을 순서대로 재조합하기 위해 필요

##### 4. TTL

- Time To Live
- 패킷의 수명
- 홉(hop): 패킷이 호스트 또는 라우터에 한 번 전달되는 것
- TTL 필드의 값은 홉마다 1씩 감소함
- TTL 값이 0으로 떨어진 패킷은 폐기되고, (ICMP 프로토콜에 의해) 패킷을 송신한 호스트에게 시간 초과 메시지가 전송됨
- 무의미한 패킷이 네트워크 상에 지속적으로 남아있는 것을 방지하기 위함

##### 5. 프로토콜

- 상위 계층의 프로토콜을 나타내는 필드
- ex) TCP(6번), UDP(17번)

##### 6. 송신지 IP 주소, 수신지 IP 주소

- 송수신지의 IPv4 주소

#### IPv6

- IPv6 패킷 헤더 내 주요 필드
  - 다음 헤더
  - 홉 제한
  - 송신지 IP 주소
  - 수신지 IP 주소
- IPv6 기본 헤더는 40바이트로 고정됨

##### 1. 다음 헤더

- 상위 계층의 프로토콜을 가리키거나 확장 헤더를 가리킴
- IPv6는 추가적인 헤더 정보가 필요할 경우, 기본 헤더와 더불어 확장 헤더라는 추가 헤더를 가질 수 있음
- 확장 헤더는 기본 헤더와 페이로드 데이터 사이에 위치함
- 확장 헤더 종류
  - 홉 간 옵션: 송신지에서 수신지에 이르는 모든 경로의 네트워크 장비가 패킷을 검사
  - 수신지 옵션: 수신지에서만 패킷을 검사
  - 라우팅: 라우팅 관련 정보
  - 단편(Fragment): 식별자, M 플래그, 단편화 오프셋 필드 포함
  - ESP(Encapsulating Security Payload): 암호화
  - AH(Authentication Header): 인증

##### 2. 홉 제한

- 패킷의 수명
- IPv4의 TTL와 유사

##### 3. 송신지 IP 주소, 수신지 IP 주소

- 송수신지의 IPv6 주소

### ARP

- Address Resolution Protocol
- 동일 네트워크 내에 있는 송수신 대상의 IP 주소를 통해 MAC 주소를 알아내는 프로토콜
- 다른 네트워크에 속한 호스트에게 패킷을 보내야 할 경우, 네트워크 외부로 나가기 위한 장비(라우터)의 MAC 주소를 알아내어 패킷을 전송함

#### 1. ARP 요청

- 동일 네트워크 내에 호스트 A, B를 포함한 다양한 호스트가 있고, 호스트 A는 호스트 B의 IP 주소를 알지만 MAC 주소는 모르는 상황임
- 이때, 호스트 A는 네트워크 내의 모든 호스트에게 브로드캐스트 메시지(ARP request 패킷)를 보냄

#### 2. ARP 응답

- 호스트 B를 제외한 나머지 호스트는 자신의 IP 주소가 아니므로 폐기함
- 호스트 B는 자신의 MAC 주소를 담은 메시지(ARP reply 패킷)를 호스트 A에게 전송함

#### 3. ARP 테이블 갱신

- ARP 테이블: IP 주소와 MAC 주소가 대응되는 표
- ARP를 활용할 수 있는 모든 호스트는 ARP 테이블을 통해 정보를 유지함
- ARP 테이블은 일정 시간이 지나면 삭제되고, 임의로 삭제할 수도 있음

### cf) IP 단편화를 피하는 방법

- IP 단편화는 되도록 하지 않는 것이 좋음
  - 이유1) 여러 패킷으로 쪼개서 전송하면, 불필요한 트래픽 증가와 대역폭 낭비로 이어질 수 있음
  - 이유2) 쪼개진 IP 패킷들을 하나로 합치는 과정에서 발생하는 부하로 성능 저하를 야기할 수 있음
- IP 단편화를 피하려면 'IP 단편화 없이 주고 받을 수 있는 최대 크기(경로 MTU)'만큼만 전송해야 함
- 경로 MTU 발견: 경로 MTU를 구하고 해당 크기만큼만 송수신하여 IP 단편화를 회피하는 기술
- 오늘날 대부분의 네트워크에서는 이를 지원하므로, IP 단편화는 자주 수행되진 않음

## 2️⃣ IP 주소

- 하나의 IP 주소는 크게 네트워크 주소와 호스트 주소로 이루어짐

### 네트워크 주소와 호스트 주소

- IP 주소에서 네트워크 주소와 호스트 주소를 구분하는 범위는 유동적일 수 있음

### 클래스풀 주소 체계

- 필요한 호스트 IP 개수에 따라 네트워크 크기를 가변적으로 조정해 네트워크 주소와 호스트 주소를 구획
- 클래스: 네트워크 크기에 따라 IP 주소를 분류하는 기준
- 클래스풀 주소 체계: 클래스를 기반으로 IP 주소를 관리하는 주소 체계

| 클래스 | 초기 비트 | 네트워크 주소 비트 / 호스트 주소 비트 | 할당 가능한 네트워크 수 | 할당 가능한 호스트 수 |
| ------ | --------- | ------------------------------------- | ----------------------- | --------------------- |
| `A`    | 0         | 8 / 24                                | 2^7                     | 2^24 - 2              |
| `B`    | 10        | 16 / 16                               | 2^14                    | 2^16 - 2              |
| `C`    | 110       | 24 / 8                                | 2^21                    | 2^8 - 2               |

- 각 클래스당 IP 주소 범위 (10진수)
  - A 클래스: 0.0.0.0 ~ 127.255.255.255
  - B 클래스: 128.0.0.0 ~ 191.255.255.255
  - C 클래스: 192.0.0.0 ~ 223.255.255.255
- 호스트 주소가 전부 0인 IP 주소는 네트워크 자체를 의미하는 **네트워크 주소**로 사용됨
- 호스트 주소가 전부 1인 IP 주소는 **브로드캐스트 주소**로 사용됨

### 클래스리스 주소 체계

- 클래스풀 주소 체계의 한계: 클래스별 네트워크의 크기가 고정되어 있기에 여전히 다수의 IP 주소가 낭비될 가능성이 큼
- 클래스리스 주소 체계: 클래스에 구애받지 않고 네트워크 영역을 나눠서 호스트에게 IP 주소 공간을 할당하는 방식
- 클래스풀 주소 체계보다 더 유동적이고 정교하게 네트워크를 구획할 수 있음

#### 서브넷 마스크

- IP 주소상에서 네트워크 주소를 1, 호스트 주소를 0으로 표기한 비트열
- 네트워크 주소와 호스트 주소를 구분 짓는 수단으로 사용함
- 서브네팅: 서브넷 마스크를 이용해 클래스를 원하는 크기로 더 잘게 쪼개어 사용하는 것

#### 서브네팅: 비트 AND 연산

- 비트 AND 연산: 피연산자가 모두 1인 경우에는 1, 아닌 경우에는 0이 되는 연산
- IP주소와 서브넷 마스크를 비트 AND 연산하면 네트워크 주소를 알아낼 수 있음

#### 서브넷 마스크 표기: CIDR 표기법

- Classless Inter-Domain Routing notation
- 'IP 주소/서브넷 마스크상의 1의 개수'로 표기하는 형식
- ex) IP 주소 192.168.219.103과 서브넷 마스크 255.255.255.0의 CIDR 표기법 = 192.168.219.103/24

### 공인 IP 주소와 사설 IP 주소

#### 공인 IP 주소

- 전 세계에서 고유한 IP 주소
- 바로, 인터넷을 이용할 때 사용하는 IP 주소임

#### 사설 IP 주소

- 사설 IP 주소: 사설 네트워크에서 사용하기 위한 IP 주소
- 사설 네트워크: 인터넷, 외부 네트워크에 공개되지 않은 네트워크
- 예약된 사설 IP 주소 공간
  - 10.0.0.0/8 (10.0.0.0 ~ 10.255.255.255)
  - 172.16.0.0/12 (172.16.0.0 ~ 172.31.255.255)
  - 192.168.0.0/16 (192.168.0.0 ~ 192.168.255.255)
- 일반적으로 라우터가 사설 IP 주소를 할당해줌
- 할당받은 사설 IP 주소는 해당 호스트가 속한 사설 네트워크상에서만 유효한 주소이므로, 얼마든지 다른 네트워크상의 사설 IP 주소와 중복될 수 있음
- 사설 IP 주소만으로는 일반적인 인터넷 접속을 비롯한 외부 네트워크 간의 통신이 어려움

#### NAT

- Network Address Translation
- IP 주소를 변환하는 기술
- 주로 네트워크 내부에서 사용되는 사설 IP 주소와 네트워크 외부에서 사용되는 공인 IP 주소를 변환하는 데 사용됨
- 대부분의 라우터와 (가정용) 공유기는 NAT 기능을 내장하고 있음

### 정적 IP 주소와 동적 IP 주소

#### 정적 할당

- 호스트에 직접 수작업으로 IP 주소를 부여하는 방식
- 정적 IP 주소: 정적 할당된 IP 주소

#### 동적 할당

- IP 주소를 직접 일일이 입력하지 않아도 호스트에 IP 주소가 동적으로 할당되는 방식
- 동적 IP 주소: 동적 할당된 IP 주소
- 동적 IP 주소는 사용되지 않을 경우 회수되고, 할당받을 때마다 다른 주소를 받을 수 있음

#### DHCP

- Dynamic Host Configuration Protocol
- IP 동적 할당에 사용되는 대표적인 프로토콜
- IP 주소를 할당받고자하는 호스트(이하 클라이언트)와 해당 호스트에게 IP 주소를 제공하는 DHCP 서버 간에 메시지를 주고 받음으로써 IP 주소 할당이 이루어짐
- 일반적으로 라우터(공유기)가 DHCP 서버 역할을 함
- DHCP로 할당받은 IP 주소는 사용할 기간(임대 기간)이 정해져 있음
- 임대 갱신을 통해 IP 주소 임대 기간이 끝나기 전에 임대 기간을 연장할 수도 있음

##### 1. DHCP Discover

- 클라이언트 → DHCP 서버
- 클라이언트는 DHCP Discover 메시지를 통해 DHCP 서버를 찾음
- 이때, 클라이언트는 아직 IP 주소를 할당받지 못했으므로 송신지 IP 주소를 0.0.0.0으로 설정

##### 2. DHCP Offer

- DHCP 서버 → 클라이언트
- DHCP 서버는 클라이언트에게 DHCP Offer 메시지를 보냄
- 이 메시지에는 클라이언트에게 제안할 IP 주소, 서브넷 마스크, 임대 기간 등의 정보가 포함되어 있음

##### 3. DHCP Request

- 클라이언트 → DHCP 서버
- DHCP Offer 메시지에 대한 응답
- 'DHCP Offer 메시지 잘 받았습니다. 이 IP 주소 써도 되죠?'

##### 4. DHCP ACK

- DHCP 서버 → 클라이언트
- DHCP 서버는 클라이언트에게 최종 승인과도 같은 ACK 메시지를 보냄

### cf) 예약 주소: 0.0.0.0 vs 127.0.0.1

| 예약 주소   | IP 범위                     | 사용 목적            |
| ----------- | --------------------------- | -------------------- |
| 0.0.0.0/8   | 0.0.0.0 ~ 0.255.255.255     | 이 네트워크의 호스트 |
| 127.0.0.0/8 | 127.0.0.0 ~ 127.255.255.255 | 루프백 주소          |

#### 루프백 주소

- loopback address
- 자기 자신을 가리키는 특별한 주소
- 가장 일반적인 주소는 127.0.0.1이고, 로컬호스트라고도 불림
- 루프백 주소로 전송된 패킷은 자기 자신에게 되돌아옴
- 주로 테스트나 디버깅 용도로 사용됨

#### 0.0.0.0/8

- This host on this network
- 호스트가 IP 주소를 할당받기 전에 임시로 사용
- 호스트 입장에서 자신을 지징할 IP 주소가 없기 때문에 '이 네트워크의 이 호스트'로 자신을 지칭

#### 0.0.0.0/0

- 모든 임의의 IP 주소
- 주고 디폴트 라우트를 나타내기 위해 사용
- 디폴트 라우트: 패킷을 어떤 IP 주소로 전달할지 결정하기 어려울 경우 기본적으로 패킷을 전달할 경로

## 3️⃣ 라우팅

- 홉(hop): 라우팅 도중 패킷이 호스트와 라우터 간, 혹은 라우터와 라우터 간에 이동하는 하나의 과정
- 패킷은 여러 홉을 거쳐 다른 네트워크 내의 호스트로 이동할 수 있음
- 라우팅: 패킷이 이동할 최적의 경로를 설정한 뒤 해당 경로로 패킷을 이동시키는 것

### 라우터

- 라우팅을 수행하는 네트워크 계층의 장비
- 일반적으로 가정 환경에서는 공유기가 라우터의 역할을 대신함
  - 라우터 기능 뿐만 아니라 NAT 기능, DHCP 서버, 보안을 위한 방화벽 등 다양한 기능이 함축됨

### 라우팅 테이블

- 특정 수신지까지 도달하기 위한 정보를 명시한 일종의 표
- 라우터는 라우팅 테이블을 참고하여 수신지까지의 도달 경로를 판단함
- 라우팅 테이블에 명시되는 대표적인 정보
  - 수신지 IP 주소, 서브넷 마스크
  - 다음 홉 (게이트웨이)
  - 네트워크 인터페이스
  - 메트릭: 해당 경로를 이동하는 드는 비용
- 라우터가 라우팅 테이블에 있는 경로 중 패킷을 내보낼 경로를 선택할 때, 메트릭이 낮은 경로를 선호함
- 라우팅 테이블에 없는 경로로 패킷을 전송해야할 경우, 디폴트 라우트(0.0.0.0/0)로 해당 패킷을 내보내게 됨

### 정적 라우팅과 동적 라우팅

- 라우팅 테이블을 만드는 방법을 기준으로 정적 라우팅과 동적 라우팅으로 나눌 수 있음

#### 정적 라우팅

- 사용자가 수동으로 직접 채워 넣은 라우팅 테이블의 항목을 토대로 라우팅되는 방식
- ex) 윈도우 운영체제에서 10.0.0.0/24로 향하는 패킷을 192.168.1.1 게이트웨이로 라우팅하는 명령어

  ```bash
  > route add 10.0.0.0 mask 255.255.255.0 192.168.1.1
  ```

#### 동적 라우팅

- 자동으로 라우팅 테이블 항목을 만들고, 이를 이용하여 라우팅하는 방식
- 따라서, 라우팅 테이블 항목이 수시로 변할 수 있음
- 네트워크 경로상에 문제가 발생했을 때, 이를 우회할 수 있게 경로가 자동으로 갱신되기도 함
- 모든 라우터는 특정 수신지까지 도달하기 위한 최적의 경로를 찾아 라우팅 테이블에 추가하려 노력함
- 이를 위해, 라우터끼리 서로 자신의 정보를 교환하게 되는데, 이 과정에서 사용되는 프로토콜이 (동적) 라우팅 프로토콜임

### 라우터 프로토콜

- 라우터끼리 자신들의 정보를 교환하며 패킷이 이동할 최적의 경로를 찾기 위한 프로토콜
- 라우팅 프로토콜은 크게 AS 내부에서 수행되느냐, AS 외부에서 수행되느냐에 따라 IGP(Interior Gateway Protocol)와 EGP(Exterior Gateway Protocol)로 나눌 수 있음

#### cf) 라우터들의 집단 네트워크 (AS)

- Autonomous System
- 동일한 라우터 정책으로 운용되는 라우터들의 집단 네트워크
- 한 회사나 단체에서 관리하는 라우터 집단
- 라우터들은 AS 내부에서만 통신할 수도 있고, AS 외부와 통신할 수도 있음
- AS 외부와 통신할 경우, AS 경계에서 AS 내외로 통신을 주고받을 수 있는 AS 경계 라우터(ASBR, AS Boundary Router)라는 특별한 라우터를 이용함

#### IGP: RIP와 OSPF

##### 1. RIP

- Routing Information Protocol
- **거리 벡터**를 사용해 최적의 경로를 찾는 라우팅 프로토콜
  - 거리: 패킷이 경우한 라우터의 수 (홉의 수)
- 특정 수신지까지 도달하기 위해 '홉 수가 가장 적은 경로'를 최적의 경로라고 판단함
- 따라서, 홉 수가 적을수록 라우팅 테이블 상의 메트릭 값도 작아짐
- 인접한 라우터끼리 경로 정보를 주기적으로 교환하며 라우팅 테이블을 갱신함

##### 2. OSPF

- Open Shortest Path First
- **링크 상태**를 사용해 최적의 경로를 찾는 라우팅 프로토콜
- 링크 상태를 비롯한 현재 네트워크 상태를 그래프의 형태로 링크 상태 데이터베이스에 저장함
  - 라우터들의 연결 관계, 연결 비용 등 현재 네트워크의 상태를 그래프로 표현하기 이한 데이터가 저장되어 있음
- 대역폭을 기반으로 메트릭을 계산함
- 대역폭이 높은 링크일수록 메트릭이 낮은 경로로 인식함
- 네트워크의 구성이 변경되었을 때 라우팅 테이블을 갱신함
- 이때, 연산 부담을 낮추기 위해 AS를 에러리어(area)라는 단위로 나누고, 구분된 에어리어 내에서만 링크 상태를 공유함
- 에어리어 경계에 있는 ABR(Area Border Router) 라우터를 통해 에어리어 간 연결이 가능함

#### EFP: BGP

- Border Gateway Protocol
- AS 간의 통신도 '가능한' 프로토콜
  - eBGP (external BGP): AS 간의 통신을 위한 BGP
  - iBGP (internal BGP): AS 내의 통신을 위한 BGP
- 피어(peer): BGP 메시지를 주고받을 수 있도록 연결된 BGP 라우터
- 최적의 경로를 결정하는 과정에서 수신지 주소와 더불어 다양한 '속성'과 '정책'이 고려되기 때문에, 경로 결정 과정이 복잡하고 일정하지 않은 경우가 많음
- 속성: 경로에 대한 일종의 부가 정보
  - AS-PATH 속성
  - NEXT-HOP 속성
  - LOCAL-PREF 속성

##### AS-PATH 속성

- 메시지가 수신지에 이르는 과정에서 통과하는 AS들의 목록
- BGP는 AS 간 라우팅을 할 때, 거치게 될 '라우터'의 수가 아닌 'AS'의 수를 고려함
- BGP는 RIP처럼 단순히 수신지에 이르는 '거리'가 아닌, 메시지가 어디를 거쳐 어디로 이동하는지 나타내는 '경로'를 고려함
  - 이유: 메시지가 같은 경로를 무한히 반복하며 이동하는 순환(loop)을 방지하기 위함

##### NEXT-HOP 속성

- 다음 홉의 IP 주소

##### LOCAL-PREF 속성

- AS 외부 경로에 있어 AS 내부에서 어떤 경로를 선호할지에 대한 척도
- AS-PATH나 NEXT-HOP 속성보다 우선시됨
- AS 관리 주체가 설정하는 정책에 영향을 받음
